variables:
  license-files: >-
    {.,**}/COPYING*
    {.,**}/COPYRIGHT*
    {.,**}/[Cc]opyright*
    {.,**}/LICEN*
    {.,**}/[Ll]icen*
  license-files-extra: ""
  license-files-final: >-
    %{license-files}
    %{license-files-extra}
  license-root: "%{build-root}"
  license-element-name: ""
  install-licenses: |
    # Force bash
    set -euo pipefail

    shopt -s globstar nullglob

    ELEMENT_NAME=%{element-name}

    case "$ELEMENT_NAME" in
      bootstrap/build/*|bootstrap/base-sdk/*) exit 0 ;;
    esac

    # Pure bash to avoid any dependencies

    NAME=$ELEMENT_NAME
    NAME=${NAME##*/}     # Basename
    NAME=${NAME%.bst}    # Strip .bst suffix

    case $NAME in
      *-base|*-config|*-daemon|*-full|*-headers|*-libs|*-manifest|*-maybe|*-minimal|*-minimal-image|*-only|*-stage1)
        NAME=${NAME%-*} # Trim suffix to normalise element name
        ;;
    esac

    [ -n "%{license-element-name}" ] && NAME=%{license-element-name}

    for pattern in %{license-files-final}; do
      for file in "%{license-root}"/$pattern; do
        [ -f "$file" ] || continue

        RESOLVED=${file#"%{license-root}"/} # Strip off root from the path

        [ -n "$NAME" ] && [ -n "$RESOLVED" ] || continue
        DEST_PATH="%{install-root}%{project_licensedir}/$NAME/$RESOLVED"
        [ -f "$DEST_PATH" ] || install -Dm0644 "$file" "$DEST_PATH"
      done
    done

  install-extra: |
    %{install-licenses}

elements:
  autotools:
    config:
      install-commands:
        (>):
        - "%{install-extra}"
  cmake:
    config:
      install-commands:
        (>):
        - "%{install-extra}"
  make:
    config:
      install-commands:
        (>):
        - "%{install-extra}"
  makemaker:
    config:
      install-commands:
        (>):
        - "%{install-extra}"
  meson:
    config:
      install-commands:
        (>):
        - "%{install-extra}"
  pyproject:
    config:
      install-commands:
        (>):
        - "%{install-extra}"
